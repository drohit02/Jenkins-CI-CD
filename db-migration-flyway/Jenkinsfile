pipeline {
    agent any

    environment {
        DB_URL      = credentials('db-url')
        DB_USER     = credentials('db-user')
        DB_PASSWORD = credentials('db-password')
    }

    stages {

        stage('Detect DB Script Changes') {
            steps {
                script {
                    env.DB_CHANGED = isDbScriptChanged()
                    echo "DB Script Changed: ${env.DB_CHANGED}"
                }
            }
        }

        stage('DB Migration') {
            when {
                expression { env.DB_CHANGED == 'true' }
            }
            steps {
                script {
                    // Using FlywayBuilder with credentials
                    step([
                        $class: 'FlywayBuilder',
                        flywayCommand: 'migrate',
                        locations: "filesystem:${env.WORKSPACE}/db-migration-flyway/db-script",
                        url: env.DB_URL,
                        user: env.DB_USER,
                        password: env.DB_PASSWORD
                    ])
                }
            }
        }

        stage('Build') {
            steps {
                echo "mvn clean package -DskipTests"  // dry-run
            }
        }

        stage('Test') {
            steps {
                echo "mvn test"  // dry-run
            }
        }

        stage('Deploy') {
            steps {
                echo "mvn deploy"  // dry-run
            }
        }
    }

    post {
        success {
            echo "Pipeline completed successfully!"
        }
        failure {
            echo "Pipeline failed. Check the logs for details."
        }
    }
}

def isDbScriptChanged() {
    echo "Checking if db-script folder has changed..."

    // Check if this is the first build
    if (currentBuild.previousBuild == null) {
        echo "First build detected â€” assuming DB migration is required"
        return 'true'
    }

    try {
        // Get current commit
        def currentCommit = env.GIT_COMMIT
        echo "Current commit: ${currentCommit}"
        
        // Get previous successful build's commit
        def previousCommit = env.GIT_PREVIOUS_SUCCESSFUL_COMMIT ?: env.GIT_PREVIOUS_COMMIT
        
        if (previousCommit == null || previousCommit == currentCommit) {
            echo "No previous commit found or same as current, checking for db-script existence"
            def dbScriptExists = fileExists('db-migration-flyway/db-script')
            if (dbScriptExists) {
                echo "db-migration-flyway/db-script folder exists, running migration"
                return 'true'
            }
            return 'false'
        }
        
        echo "Previous commit: ${previousCommit}"
        
        // Check for changes in db-migration-flyway/db-script directory between commits
        def changes = sh(
            script: """
                git diff --name-only ${previousCommit} ${currentCommit} | grep '^db-migration-flyway/db-script/' || true
            """,
            returnStdout: true
        ).trim()

        if (changes) {
            echo "DB script changes detected:\n${changes}"
            return 'true'
        } else {
            echo "No DB script changes detected between ${previousCommit} and ${currentCommit}"
            return 'false'
        }
    } catch (Exception e) {
        echo "Error checking for DB changes: ${e.message}"
        echo "Defaulting to running migration as a safety measure"
        return 'true'
    }
}