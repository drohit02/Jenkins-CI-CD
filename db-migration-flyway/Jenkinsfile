pipeline {
    agent any

    environment {
        DB_URL      = credentials('db-url')
        DB_USER     = credentials('db-user')
        DB_PASSWORD = credentials('db-password')
    }

    stages {

        stage('Detect DB Script Changes') {
            steps {
                script {
                    env.DB_CHANGED = isDbScriptChanged()
                    echo "DB Script Changed: ${env.DB_CHANGED}"
                }
            }
        }

        stage('DB Migration') {
            when {
                expression { env.DB_CHANGED == 'true' }
            }
            steps {
                echo "Flyway migrate --url=${env.DB_URL} --user=${env.DB_USER} --password=**** --locations=filesystem:${env.WORKSPACE}/db-script"
            }
        }

        stage('Build') {
            steps {
                echo "mvn clean package -DskipTests"
            }
        }

        stage('Test') {
            steps {
                echo "mvn test"
            }
        }

        stage('Deploy') {
            steps {
                echo "mvn deploy"
            }
        }
    }
}
def isDbScriptChanged() {
    echo "Checking if db-script folder has changed..."

    // Simulate first build detection
    def hasPreviousCommit = 'false' // For dry-run, we assume first build
    if (hasPreviousCommit == 'false') {
        echo "First build detected â€” assuming DB migration is required"
        return 'true'
    }

    // Normally, you would check git diff here
    def output = 'db-script/V1__init.sql' // Simulated changed file
    return output ? 'true' : 'false'
}
