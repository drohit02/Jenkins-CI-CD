pipeline {
    agent any

    environment {
        DB_URL      = credentials('db-url')
        DB_USER     = credentials('db-user')
        DB_PASSWORD = credentials('db-password')
    }

    stages {

        stage('Detect DB Script Changes') {
            steps {
                script {
                    env.DB_CHANGED = isDbScriptChanged()
                    echo "DB Script Changed: ${env.DB_CHANGED}"
                }
            }
        }

        stage('DB Migration') {
            when {
                expression { env.DB_CHANGED == 'true' }
            }
            steps {
                script {
                    // Using FlywayBuilder with credentials
                    step([
                        $class: 'FlywayBuilder',
                        flywayCommand: 'migrate',
                        locations: "filesystem:${env.WORKSPACE}/db-script",
                        url: env.DB_URL,
                        user: env.DB_USER,
                        password: env.DB_PASSWORD
                    ])
                }
            }
        }

        stage('Build') {
            steps {
                echo "mvn clean package -DskipTests"  // dry-run
            }
        }

        stage('Test') {
            steps {
                echo "mvn test"  // dry-run
            }
        }

        stage('Deploy') {
            steps {
                echo "mvn deploy"  // dry-run
            }
        }
    }

    post {
        success {
            echo "Pipeline completed successfully!"
        }
        failure {
            echo "Pipeline failed. Check the logs for details."
        }
    }
}

def isDbScriptChanged() {
    echo "Checking if db-script folder has changed..."

    // Check if this is the first build
    def previousBuild = currentBuild.previousBuild
    if (previousBuild == null) {
        echo "First build detected â€” assuming DB migration is required"
        return 'true'
    }

    // Check for changes in db-script directory
    try {
        def changes = sh(
            script: """
                git diff --name-only HEAD~1 HEAD | grep '^db-script/' || true
            """,
            returnStdout: true
        ).trim()

        if (changes) {
            echo "DB script changes detected:\n${changes}"
            return 'true'
        } else {
            echo "No DB script changes detected"
            return 'false'
        }
    } catch (Exception e) {
        echo "Error checking for DB changes: ${e.message}"
        echo "Defaulting to running migration as a safety measure"
        return 'true'
    }
}